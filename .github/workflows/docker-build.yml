name: Build Mapnik Docker Images

on:
  push:
    tags: ["v*"]
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:
    inputs:
      force_push:
        description: "Force push images to registry"
        required: false
        type: boolean
        default: false
      no_cache:
        description: "Disable build cache"
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  packages: write

env:
  REGISTRY: docker.io
  # Base version is now dynamic (git tag or sha)
  BOOST_VERSION: 1.90.0
  PROJ_VERSION: 9.7.1
  GDAL_VERSION: 3.12.1
  MAPNIK_VERSION: 4.2.0

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      image_name: ${{ steps.image-name.outputs.name }}
      base_version: ${{ steps.version.outputs.tag }}
      registry: ${{ steps.vars.outputs.registry }}
      boost_version: ${{ steps.vars.outputs.boost_version }}
      proj_version: ${{ steps.vars.outputs.proj_version }}
      gdal_version: ${{ steps.vars.outputs.gdal_version }}
      mapnik_version: ${{ steps.vars.outputs.mapnik_version }}
    steps:
      - name: Calculate Image Name
        id: image-name
        run: |
          echo "name=${GITHUB_REPOSITORY,,}" >> $GITHUB_OUTPUT

      - name: Calculate Base Version
        id: version
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "tag=base-${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "tag=base-$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
          fi

      - name: Export Variables
        id: vars
        run: |
          echo "registry=${{ env.REGISTRY }}" >> $GITHUB_OUTPUT
          echo "boost_version=${{ env.BOOST_VERSION }}" >> $GITHUB_OUTPUT
          echo "proj_version=${{ env.PROJ_VERSION }}" >> $GITHUB_OUTPUT
          echo "gdal_version=${{ env.GDAL_VERSION }}" >> $GITHUB_OUTPUT
          echo "mapnik_version=${{ env.MAPNIK_VERSION }}" >> $GITHUB_OUTPUT

      - name: Job Summary
        run: |
          echo "### Build Configuration ðŸ› ï¸" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Base | ${{ steps.version.outputs.tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Boost | ${{ env.BOOST_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PROJ | ${{ env.PROJ_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GDAL | ${{ env.GDAL_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Mapnik | ${{ env.MAPNIK_VERSION }} |" >> $GITHUB_STEP_SUMMARY

  base:
    needs: setup
    uses: ./.github/workflows/reusable-build.yml
    with:
      component: base
      dockerfile: Dockerfile.base
      meta_images: ${{ needs.setup.outputs.registry }}/${{ needs.setup.outputs.image_name }}-base
      meta_tags: type=raw,value=${{ needs.setup.outputs.base_version }}
      force_push: ${{ inputs.force_push == true }}
      no_cache: ${{ inputs.no_cache == true }}
      registry: ${{ needs.setup.outputs.registry }}
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PERSONAL_ACCESS_TOKEN: ${{ secrets.DOCKER_PERSONAL_ACCESS_TOKEN }}

  boost:
    needs: [setup, base]
    uses: ./.github/workflows/reusable-build.yml
    with:
      component: boost
      dockerfile: Dockerfile.boost
      previous_component: base
      build_args: |
        BOOST_VERSION=${{ needs.setup.outputs.boost_version }}
        BASE_IMAGE=${{ (github.ref_type == 'tag' || inputs.force_push == true) && format('{0}/{1}-base:{2}', needs.setup.outputs.registry, needs.setup.outputs.image_name, needs.setup.outputs.base_version) || 'mapnik-base:local' }}
      meta_images: ${{ needs.setup.outputs.registry }}/${{ needs.setup.outputs.image_name }}-boost
      meta_tags: type=raw,value=${{ needs.setup.outputs.boost_version }}
      force_push: ${{ inputs.force_push == true }}
      no_cache: ${{ inputs.no_cache == true }}
      registry: ${{ needs.setup.outputs.registry }}
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PERSONAL_ACCESS_TOKEN: ${{ secrets.DOCKER_PERSONAL_ACCESS_TOKEN }}

  proj:
    needs: [setup, boost]
    uses: ./.github/workflows/reusable-build.yml
    with:
      component: proj
      dockerfile: Dockerfile.proj
      previous_component: boost
      build_args: |
        PROJ_VERSION=${{ needs.setup.outputs.proj_version }}
        BASE_IMAGE=${{ (github.ref_type == 'tag' || inputs.force_push == true) && format('{0}/{1}-boost:{2}', needs.setup.outputs.registry, needs.setup.outputs.image_name, needs.setup.outputs.boost_version) || 'mapnik-boost:local' }}
      meta_images: ${{ needs.setup.outputs.registry }}/${{ needs.setup.outputs.image_name }}-proj
      meta_tags: |
        type=raw,value=${{ needs.setup.outputs.proj_version }}
        ${{ github.event_name == 'pull_request' && 'mapnik-proj:latest' || '' }}
      force_push: ${{ inputs.force_push == true }}
      no_cache: ${{ inputs.no_cache == true }}
      registry: ${{ needs.setup.outputs.registry }}
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PERSONAL_ACCESS_TOKEN: ${{ secrets.DOCKER_PERSONAL_ACCESS_TOKEN }}

  gdal:
    needs: [setup, proj]
    uses: ./.github/workflows/reusable-build.yml
    with:
      component: gdal
      dockerfile: Dockerfile.gdal
      previous_component: proj
      build_args: |
        GDAL_VERSION=${{ needs.setup.outputs.gdal_version }}
        BASE_IMAGE=${{ (github.ref_type == 'tag' || inputs.force_push == true) && format('{0}/{1}-proj:{2}', needs.setup.outputs.registry, needs.setup.outputs.image_name, needs.setup.outputs.proj_version) || 'mapnik-proj:local' }}
      meta_images: ${{ needs.setup.outputs.registry }}/${{ needs.setup.outputs.image_name }}-gdal
      meta_tags: type=raw,value=${{ needs.setup.outputs.gdal_version }}
      force_push: ${{ inputs.force_push == true }}
      no_cache: ${{ inputs.no_cache == true }}
      registry: ${{ needs.setup.outputs.registry }}
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PERSONAL_ACCESS_TOKEN: ${{ secrets.DOCKER_PERSONAL_ACCESS_TOKEN }}

  mapnik:
    needs: [setup, gdal]
    uses: ./.github/workflows/reusable-build.yml
    with:
      component: mapnik
      dockerfile: Dockerfile.mapnik
      previous_component: gdal
      build_args: |
        MAPNIK_VERSION=${{ needs.setup.outputs.mapnik_version }}
        BASE_IMAGE=${{ (github.ref_type == 'tag' || inputs.force_push == true) && format('{0}/{1}-gdal:{2}', needs.setup.outputs.registry, needs.setup.outputs.image_name, needs.setup.outputs.gdal_version) || 'mapnik-gdal:local' }}
      meta_images: ${{ needs.setup.outputs.registry }}/${{ needs.setup.outputs.image_name }}
      meta_tags: |
        type=raw,value=${{ needs.setup.outputs.base_version }}
        type=raw,value=mapnik-${{ needs.setup.outputs.mapnik_version }}
      force_push: ${{ inputs.force_push == true }}
      no_cache: ${{ inputs.no_cache == true }}
      registry: ${{ needs.setup.outputs.registry }}
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PERSONAL_ACCESS_TOKEN: ${{ secrets.DOCKER_PERSONAL_ACCESS_TOKEN }}
